# RuoYi-Chat 测试环境使用说明

## 概述

为了解决JWT验证错误问题，我们创建了一个无需JWT验证的测试环境，可以直接测试聊天功能。

## 修改内容

### 1. 后端修改

#### 创建测试控制器
- 文件：`ruoyi-chat/src/main/java/com/ruoyi/chat/controller/TestChatController.java`
- 路径：`/test/chat/**`
- 特点：使用固定的测试用户ID（1L），无需JWT验证

#### 支持的API接口

**会话相关：**
- `POST /test/chat/session/private` - 创建私聊会话
- `POST /test/chat/session/group` - 创建群聊会话
- `GET /test/chat/sessions` - 获取用户会话列表
- `GET /test/chat/session/{sessionId}` - 获取会话详情
- `GET /test/chat/session/{sessionId}/members` - 获取会话成员
- `POST /test/chat/session/{sessionId}/join` - 加入会话
- `POST /test/chat/session/{sessionId}/leave` - 离开会话

**消息相关：**
- `POST /test/chat/message/send` - 发送消息
- `GET /test/chat/session/{sessionId}/messages` - 获取会话消息（分页）
- `GET /test/chat/session/{sessionId}/messages/latest` - 获取最新消息
- `POST /test/chat/message/{messageId}/read` - 标记消息已读
- `POST /test/chat/session/{sessionId}/messages/read` - 批量标记消息已读
- `POST /test/chat/message/{messageId}/recall` - 撤回消息
- `GET /test/chat/message/{messageId}` - 获取消息详情

**用户相关：**
- `GET /test/chat/user/info` - 获取测试用户信息

### 2. 前端修改

#### 更新API配置
- 文件：`test/src/config/test-config.js`
- 修改：将所有API端点改为测试版本（`/test/chat/**`）

#### 更新WebSocket工具
- 文件：`test/src/utils/ChatWebSocket.js`
- 修改：用户ID改为1，与后端测试用户ID保持一致

#### 更新Vue组件
- 文件：`test/src/App.vue`
- 修改：移除API调用中的Authorization头，使用配置文件中的端点

## 使用方法

### 1. 启动后端服务
```bash
cd /Users/fanzijian/WorkSpace/RuoYi-Chat
mvn spring-boot:run -pl ruoyi-admin
```

### 2. 启动前端测试项目
```bash
cd /Users/fanzijian/WorkSpace/RuoYi-Chat/test
npm run dev
```

### 3. 访问测试页面
- 前端地址：http://localhost:5173
- 后端地址：http://localhost:8080

### 4. 测试功能

1. **创建会话**
   - 点击"创建会话"按钮
   - 选择私聊或群聊
   - 填写相关信息

2. **发送消息**
   - 选择会话
   - 在输入框中输入消息
   - 点击发送或按回车键

3. **WebSocket连接**
   - 页面加载后自动连接WebSocket
   - 连接状态显示在页面顶部
   - 支持自动重连

## 测试用户信息

- **测试用户ID**: 1
- **用户名**: testuser
- **WebSocket端口**: 9999
- **HTTP端口**: 8080

## 注意事项

1. **仅用于测试**：此配置仅用于开发测试，生产环境请使用正常的JWT验证

2. **固定用户ID**：所有操作都使用用户ID为1的测试用户

3. **无需认证**：测试接口不需要JWT token，可以直接调用

4. **数据库要求**：确保数据库中存在用户ID为1的用户记录

5. **WebSocket认证**：WebSocket连接仍需要发送认证消息，但使用测试token

## 故障排除

### 1. 连接失败
- 检查后端服务是否启动（端口8080）
- 检查WebSocket服务是否启动（端口9999）
- 查看浏览器控制台错误信息

### 2. API调用失败
- 检查API路径是否正确（应为`/test/chat/**`）
- 查看后端日志
- 确认数据库连接正常

### 3. 数据库错误
- 确保数据库表结构正确
- 检查用户ID为1的用户是否存在
- 查看数据库连接配置

## 恢复正常环境

测试完成后，如需恢复正常的JWT验证环境：

1. 前端使用原始的API路径（`/chat/**`）
2. 恢复Authorization头的使用
3. 使用真实的用户认证流程
4. 删除或注释TestChatController（可选）
