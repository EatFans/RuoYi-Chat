<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.chat.mapper.ChatMessageReadMapper">

    <resultMap id="BaseResultMap" type="com.ruoyi.chat.domain.entity.ChatMessageRead">
        <id column="id" property="id" jdbcType="BIGINT"/>
        <result column="message_id" property="messageId" jdbcType="VARCHAR"/>
        <result column="session_id" property="sessionId" jdbcType="VARCHAR"/>
        <result column="user_id" property="userId" jdbcType="BIGINT"/>
        <result column="read_time" property="readTime" jdbcType="TIMESTAMP"/>
    </resultMap>

    <!-- 根据消息ID查询阅读状态列表 -->
    <select id="selectReadStatusByMessageId" parameterType="java.lang.String" resultMap="BaseResultMap">
        SELECT *
        FROM chat_message_read
        WHERE message_id = #{messageId}
        ORDER BY read_time ASC
    </select>

    <!-- 根据会话ID和用户ID查询阅读状态 -->
    <select id="selectReadStatusBySessionIdAndUserId" resultMap="BaseResultMap">
        SELECT *
        FROM chat_message_read
        WHERE session_id = #{sessionId}
          AND user_id = #{userId}
        ORDER BY read_time DESC
    </select>

    <!-- 批量插入阅读状态 -->
    <insert id="insertBatchReadStatus" parameterType="java.util.List">
        INSERT IGNORE INTO chat_message_read (
            message_id, session_id, user_id, read_time
        ) VALUES
        <foreach collection="list" item="readStatus" separator=",">
            (
                #{readStatus.messageId},
                #{readStatus.sessionId},
                #{readStatus.userId},
                #{readStatus.readTime}
            )
        </foreach>
    </insert>

    <!-- 查询消息已读用户数量 -->
    <select id="countReadUsersByMessageId" parameterType="java.lang.String" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM chat_message_read
        WHERE message_id = #{messageId}
    </select>

    <!-- 检查用户是否已读消息 -->
    <select id="checkUserReadMessage" resultType="java.lang.Boolean">
        SELECT COUNT(*) > 0
        FROM chat_message_read
        WHERE message_id = #{messageId}
          AND user_id = #{userId}
    </select>

</mapper>