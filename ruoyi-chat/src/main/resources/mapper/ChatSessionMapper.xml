<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.chat.mapper.ChatSessionMapper">

    <resultMap id="BaseResultMap" type="com.ruoyi.chat.domain.entity.ChatSession">
        <id column="id" property="id" jdbcType="BIGINT"/>
        <result column="session_id" property="sessionId" jdbcType="VARCHAR"/>
        <result column="session_type" property="sessionType" jdbcType="TINYINT"/>
        <result column="session_name" property="sessionName" jdbcType="VARCHAR"/>
        <result column="session_avatar" property="sessionAvatar" jdbcType="VARCHAR"/>
        <result column="creator_id" property="creatorId" jdbcType="BIGINT"/>
        <result column="max_members" property="maxMembers" jdbcType="INTEGER"/>
        <result column="status" property="status" jdbcType="TINYINT"/>
        <result column="create_time" property="createTime" jdbcType="TIMESTAMP"/>
        <result column="update_time" property="updateTime" jdbcType="TIMESTAMP"/>
    </resultMap>

    <!-- 根据用户ID查询会话列表 -->
    <select id="selectSessionsByUserId" parameterType="java.lang.Long" resultMap="BaseResultMap">
        SELECT DISTINCT s.*
        FROM chat_session s
        INNER JOIN chat_session_member m ON s.session_id = m.session_id
        WHERE m.user_id = #{userId}
          AND m.status = 1
          AND s.status = 1
        ORDER BY s.update_time DESC
    </select>

    <!-- 根据会话ID和用户ID查询会话 -->
    <select id="selectSessionByIdAndUserId" resultMap="BaseResultMap">
        SELECT DISTINCT s.*
        FROM chat_session s
        INNER JOIN chat_session_member m ON s.session_id = m.session_id
        WHERE s.session_id = #{sessionId}
          AND m.user_id = #{userId}
          AND m.status = 1
          AND s.status = 1
    </select>

    <!-- 根据两个用户ID查询私聊会话 -->
    <select id="selectPrivateSessionByUserIds" resultMap="BaseResultMap">
        SELECT s.*
        FROM chat_session s
        WHERE s.session_type = 1
          AND s.status = 1
          AND s.session_id IN (
              SELECT m1.session_id
              FROM chat_session_member m1
              INNER JOIN chat_session_member m2 ON m1.session_id = m2.session_id
              WHERE m1.user_id = #{userId1}
                AND m2.user_id = #{userId2}
                AND m1.status = 1
                AND m2.status = 1
              GROUP BY m1.session_id
              HAVING COUNT(*) = 2
          )
        LIMIT 1
    </select>

    <!-- 插入会话 -->
    <insert id="insert" parameterType="com.ruoyi.chat.domain.entity.ChatSession">
        INSERT INTO chat_session (
            session_id, session_type, session_name, session_avatar, 
            creator_id, max_members, status, create_time, update_time
        ) VALUES (
            #{sessionId}, #{sessionType}, #{sessionName}, #{sessionAvatar},
            #{creatorId}, #{maxMembers}, #{status}, #{createTime}, #{updateTime}
        )
    </insert>

</mapper>